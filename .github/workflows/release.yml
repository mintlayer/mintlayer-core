name: Build, Sign, and Release

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'
  pull_request:

env:
  BINARY_LIST: api-blockchain-scanner-daemon,api-web-server,dns-server,node-daemon,wallet-address-generator,wallet-cli,wallet-rpc-daemon

jobs:
  build-macos:
    runs-on: macos-12
    strategy:
      matrix:
        arch: [aarch64, x86_64]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version extracted: $VERSION"
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.arch }}-apple-darwin
    
    - name: Build
      run: |
        cargo build --release --target ${{ matrix.arch }}-apple-darwin
    
    - name: Sign and Notarize GUI
      env:
        MACOS_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
        MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        MACOS_CERTIFICATE_NAME: ${{ secrets.MACOS_CERTIFICATE_NAME }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        VERSION: ${{ steps.get_version.outputs.VERSION }}
      run: |
        ./build-tools/osx/sign_and_notarize.sh ${{ matrix.arch }} ${{ steps.get_version.outputs.VERSION }}
    
    - name: Package Mintlayer Node (without GUI)
      run: |
        mkdir -p Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
        IFS=',' read -ra BINARIES <<< "${{ env.BINARY_LIST }}"
        for binary in "${BINARIES[@]}"; do
          cp target/${{ matrix.arch }}-apple-darwin/release/$binary Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}/
        done
        zip -r Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.zip Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
    
    - name: Upload DMG Artifact (GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
        path: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.dmg
    
    - name: Upload Node Artifact (without GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
        path: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.zip

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [aarch64, x86_64]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version extracted: $VERSION"
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.arch }}-unknown-linux-gnu
    
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
    
    - name: Install dependencies
      run: |
        sudo apt-get install -y debhelper rpm zip
    
    - name: Build
      run: |
        cargo build --release --target ${{ matrix.arch }}-unknown-linux-gnu
    
    - name: Create Debian package for GUI
      run: |
        mkdir -p debian-gui/DEBIAN
        mkdir -p debian-gui/usr/bin
        cp target/${{ matrix.arch }}-unknown-linux-gnu/release/node-gui debian-gui/usr/bin/
        cat << EOF > debian-gui/DEBIAN/control
        Package: mintlayer-node-gui
        Version: ${{ steps.get_version.outputs.VERSION }}
        Section: utils
        Priority: optional
        Architecture: ${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}
        Maintainer: Your Name <your.email@example.com>
        Description: Mintlayer Node GUI
         A graphical user interface for the Mintlayer node.
        EOF
        dpkg-deb --build debian-gui
        mv debian-gui.deb Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}.deb
    
    - name: Create Debian package for Node (without GUI)
      run: |
        mkdir -p debian-node/DEBIAN
        mkdir -p debian-node/usr/bin
        IFS=',' read -ra BINARIES <<< "${{ env.BINARY_LIST }}"
        for binary in "${BINARIES[@]}"; do
          cp target/${{ matrix.arch }}-unknown-linux-gnu/release/$binary debian-node/usr/bin/
        done
        cat << EOF > debian-node/DEBIAN/control
        Package: mintlayer-node
        Version: ${{ steps.get_version.outputs.VERSION }}
        Section: utils
        Priority: optional
        Architecture: ${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}
        Maintainer: Your Name <your.email@example.com>
        Description: Mintlayer Node
         Mintlayer node and associated tools.
        EOF
        dpkg-deb --build debian-node
        mv debian-node.deb Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}.deb
    
    - name: Create RPM package for GUI
      run: |
        mkdir -p rpmbuild/{SPECS,SOURCES,BUILD,RPMS,SRPMS}
        cp target/${{ matrix.arch }}-unknown-linux-gnu/release/node-gui rpmbuild/SOURCES/
        cat << EOF > rpmbuild/SPECS/mintlayer-node-gui.spec
        Name:           mintlayer-node-gui
        Version:        ${{ steps.get_version.outputs.VERSION }}
        Release:        1%{?dist}
        Summary:        Mintlayer Node GUI
        License:        Proprietary
        URL:            https://mintlayer.org
        BuildArch:      ${{ matrix.arch }}
        
        %description
        A graphical user interface for the Mintlayer node.
        
        %install
        mkdir -p %{buildroot}/usr/bin
        cp %{_sourcedir}/node-gui %{buildroot}/usr/bin/
        
        %files
        /usr/bin/node-gui
        
        %changelog
        * $(date "+%a %b %d %Y") Your Name <your.email@example.com> - ${{ steps.get_version.outputs.VERSION }}-1
        - Initial RPM release
        EOF
        rpmbuild --target ${{ matrix.arch }}-unknown-linux-gnu -bb rpmbuild/SPECS/mintlayer-node-gui.spec
        mv rpmbuild/RPMS/${{ matrix.arch }}/mintlayer-node-gui-${{ steps.get_version.outputs.VERSION }}-1.${{ matrix.arch }}.rpm Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.rpm
    
    - name: Create RPM package for Node (without GUI)
      run: |
        mkdir -p rpmbuild/{SPECS,SOURCES,BUILD,RPMS,SRPMS}
        IFS=',' read -ra BINARIES <<< "${{ env.BINARY_LIST }}"
        for binary in "${BINARIES[@]}"; do
          cp target/${{ matrix.arch }}-unknown-linux-gnu/release/$binary rpmbuild/SOURCES/
        done
        cat << EOF > rpmbuild/SPECS/mintlayer-node.spec
        Name:           mintlayer-node
        Version:        ${{ steps.get_version.outputs.VERSION }}
        Release:        1%{?dist}
        Summary:        Mintlayer Node
        License:        Proprietary
        URL:            https://mintlayer.org
        BuildArch:      ${{ matrix.arch }}
        
        %description
        Mintlayer node and associated tools.
        
        %install
        mkdir -p %{buildroot}/usr/bin
        cp %{_sourcedir}/* %{buildroot}/usr/bin/
        
        %files
        /usr/bin/*
        
        %changelog
        * $(date "+%a %b %d %Y") Your Name <your.email@example.com> - ${{ steps.get_version.outputs.VERSION }}-1
        - Initial RPM release
        EOF
        rpmbuild --target ${{ matrix.arch }}-unknown-linux-gnu -bb rpmbuild/SPECS/mintlayer-node.spec
        mv rpmbuild/RPMS/${{ matrix.arch }}/mintlayer-node-${{ steps.get_version.outputs.VERSION }}-1.${{ matrix.arch }}.rpm Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.rpm
    
    - name: Package Mintlayer Node (without GUI) as ZIP
      run: |
        mkdir -p Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
        IFS=',' read -ra BINARIES <<< "${{ env.BINARY_LIST }}"
        for binary in "${BINARIES[@]}"; do
          cp target/${{ matrix.arch }}-unknown-linux-gnu/release/$binary Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}/
        done
        zip -r Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.zip Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}
    
    - name: Upload GUI DEB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}_deb
        path: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}.deb
    
    - name: Upload Node DEB Artifact (without GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}_deb
        path: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }}.deb
    
    - name: Upload GUI RPM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}_rpm
        path: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.rpm
    
    - name: Upload Node RPM Artifact (without GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}_rpm
        path: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.rpm
    
    - name: Upload Node ZIP Artifact (without GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}_zip
        path: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_${{ matrix.arch }}.zip

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Extract version from tag
      id: get_version
      run: |
        $VERSION = $env:GITHUB_REF -replace 'refs/tags/', '' -replace '^v', ''
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        echo "Version extracted: $VERSION"
      shell: pwsh
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Build
      run: cargo build --release
    
    - name: Package Mintlayer Node (without GUI)
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        $DEST = "Mintlayer_Node_${VERSION}_win64"
        New-Item -ItemType Directory -Path $DEST
        $env:BINARY_LIST -split ',' | ForEach-Object {
          Copy-Item "target\release\$_.exe" -Destination $DEST
        }
        Compress-Archive -Path $DEST -DestinationPath "${DEST}.zip"
      shell: pwsh
    
    - name: Package Mintlayer Node GUI
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        $DEST = "Mintlayer_Node_GUI_${VERSION}_win64"
        New-Item -ItemType Directory -Path $DEST
        Copy-Item "target\release\node-gui.exe" -Destination $DEST
        Compress-Archive -Path $DEST -DestinationPath "${DEST}.zip"
      shell: pwsh
      
    - name: Upload Node ZIP Artifact (without GUI)
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_win64_zip
        path: Mintlayer_Node_${{ steps.get_version.outputs.VERSION }}_win64.zip
    
    - name: Upload GUI ZIP Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_win64_zip
        path: Mintlayer_Node_GUI_${{ steps.get_version.outputs.VERSION }}_win64.zip

  create-release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "Mintlayer_Node_GUI_*/*.dmg,Mintlayer_Node_GUI_*/*.deb,Mintlayer_Node_GUI_*/*.rpm,Mintlayer_Node_GUI_*/*.zip,Mintlayer_Node_*/*.zip,Mintlayer_Node_*/*.deb,Mintlayer_Node_*/*.rpm"
        artifactErrorsFailBuild: true
        name: "Release ${{ steps.get_version.outputs.VERSION }}"
        body: |
          Release version ${{ steps.get_version.outputs.VERSION }}

          This release includes the following packages:

          macOS:
          - Mintlayer Node GUI (DMG) for Intel and Apple Silicon
          - Mintlayer Node (ZIP) for Intel and Apple Silicon

          Linux:
          - Mintlayer Node GUI (DEB and RPM) for x86_64 and ARM64
          - Mintlayer Node (DEB, RPM, and ZIP) for x86_64 and ARM64

          Windows:
          - Mintlayer Node GUI (ZIP) for x64
          - Mintlayer Node (ZIP) for x64

          Please download the appropriate package for your system.
        token: ${{ secrets.GITHUB_TOKEN }}