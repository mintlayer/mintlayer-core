name: Build, Sign, and Release

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'
  pull_request:
 
jobs:
  build-macos:
    uses: ./.github/workflows/build-macos.yml
    with:
      binary_list: api-blockchain-scanner-daemon,api-web-server,dns-server,node-daemon,wallet-address-generator,wallet-cli,wallet-rpc-daemon
    secrets: inherit

  build-linux:
    uses: ./.github/workflows/build-linux.yml
    with:
      binary_list: api-blockchain-scanner-daemon,api-web-server,dns-server,node-daemon,wallet-address-generator,wallet-cli,wallet-rpc-daemon
    secrets: inherit

  build-windows:
    uses: ./.github/workflows/build-windows.yml
    with:
      binary_list: api-blockchain-scanner-daemon,api-web-server,dns-server,node-daemon,wallet-address-generator,wallet-cli,wallet-rpc-daemon
    secrets: inherit

  build-docker:
      uses: ./.github/workflows/build-docker.yml
      secrets: inherit
  
  create-release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Download Artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true    
        artifacts: "Mintlayer_Node_*/*.dmg,Mintlayer_Node_*/*.deb,Mintlayer_Node_*/*.zip"
        artifactErrorsFailBuild: true
        name: "Release ${{ steps.get_version.outputs.VERSION }}"
        body: |
          Release version ${{ steps.get_version.outputs.VERSION }}

          This release includes the following packages:

          macOS:
          - Mintlayer Node GUI (DMG) for Intel and Apple Silicon
          - Mintlayer Node (ZIP) for Intel and Apple Silicon

          Linux:
          - Mintlayer Node GUI (DEB) for x86_64 and ARM64
          - Mintlayer Node (DEB and ZIP) for x86_64 and ARM64

          Windows:
          - Mintlayer Node GUI (ZIP) for x64
          - Mintlayer Node (ZIP) for x64

          Please download the appropriate package for your system.
        token: ${{ secrets.GITHUB_TOKEN }}
